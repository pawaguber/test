<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Статусы</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<nav class="nav">
    <a href="index.html">Добавить лид</a>
    <a href="statuses.html" class="active">Статусы лидов</a>
</nav>
<main class="container">
    <h1>Статусы лидов</h1>
    <form id="filterForm" class="card filters">
        <label>Дата от
            <input type="datetime-local" id="date_from">
        </label>
        <label>Дата до
            <input type="datetime-local" id="date_to">
        </label>
        <label>Лимит
            <input type="number" id="limit" value="100">
        </label>
        <button type="submit">Обновить</button>
    </form>
    <div class="card">
        <table class="table" id="statusTable">
            <thead>
            <tr>
                <th>id</th>
                <th>email</th>
                <th>status</th>
                <th>ftd</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <div id="msg" class="result" aria-live="polite"></div>
</main>
<script>
    (() => {
        const TOKEN = 'ba67df6a-a17c-476f-8e95-bcdb75ed3958';
        const GET_URL = 'https://crm.belmar.pro/api/v1/getstatuses';
        const df = document.getElementById('date_from');
        const dt = document.getElementById('date_to');
        const limit = document.getElementById('limit');
        const tbody = document.querySelector('#statusTable tbody');
        const msg = document.getElementById('msg');
        const filterForm = document.getElementById('filterForm');

        const pad = n => n < 10 ? '0' + n : n;
        const toLocalDTValue = d => {
            const yyyy = d.getFullYear();
            const MM = pad(d.getMonth() + 1);
            const DD = pad(d.getDate());
            const hh = pad(d.getHours());
            const mm = pad(d.getMinutes());
            return `${yyyy}-${MM}-${DD}T${hh}:${mm}`;
        };
        const now = new Date();
        const minus30 = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
        df.value = toLocalDTValue(minus30);
        dt.value = toLocalDTValue(now);

        const toApiFormatLocal = dtStr => {
            if (!dtStr) return '';
            const d = new Date(dtStr);
            const yyyy = d.getFullYear();
            const MM = pad(d.getMonth() + 1);
            const DD = pad(d.getDate());
            const hh = pad(d.getHours());
            const mm = pad(d.getMinutes());
            return `${yyyy}-${MM}-${DD} ${hh}:${mm}:00`;
        };

        const loadStatuses = async e => {
            if (e) e.preventDefault();
            tbody.innerHTML = '';
            const payload = {
                date_from: toApiFormatLocal(df.value),
                date_to: toApiFormatLocal(dt.value),
                page: 0,
                limit: Math.max(1, Math.min(500, Number(limit.value) || 100))
            };

            try {
                const resp = await fetch(GET_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'token': TOKEN
                    },
                    body: JSON.stringify(payload)
                });
                const data = await resp.json();
                if (data?.status) {
                    const rows = data.data;
                    if (!rows.length) {
                        msg.textContent = 'Нет данных за выбранный период.';
                    } else {
                        const fr = document.createDocumentFragment();
                        rows.forEach(r => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                            <td>${r.id ?? ''}</td>
                            <td>${r.email ?? ''}</td>
                            <td>${r.status ?? ''}</td>
                            <td>${r.ftd ?? ''}</td>`;
                            fr.appendChild(tr);
                        });
                        tbody.appendChild(fr);
                        msg.textContent = `Показано записей: ${rows.length}`;
                    }
                }
            } catch (e) {
                console.error(e);
            }
        };

        filterForm.addEventListener('submit', loadStatuses);
        loadStatuses();
    })();
</script>
</body>
</html>